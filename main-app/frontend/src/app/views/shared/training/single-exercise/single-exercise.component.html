<form
    *ngFor="let group of form.controls; let i = index"
    class="form"
    [formGroup]="group">
    <ion-card class="wrapper">
        <ng-container formGroupName="exerciseData">
            <ion-grid>
                <ion-row class="ion-text-center exercise-row">
                    <ion-col size="10">
                        <ion-item fill="outline">
                            <ion-label position="floating">{{
                                'training.new_training.pick_exercise' | translate
                            }}</ion-label>
                            <ion-select
                                *ngIf="isExercisePicker$ | async"
                                #exercisePicker
                                class="exercise-picker"
                                interface="popover"
                                formControlName="name"
                                (ionChange)="onExerciseNameChange(i, exercisePicker)"
                            >
                                <ion-select-option
                                    *ngFor="
                                        let exercise of currentExercisesState$ | async | filterAvailableExercises: i
                                    "
                                    [value]="exercise.name"
                                >
                                    {{ exercise.name | translate }}
                                </ion-select-option>
                            </ion-select>
                            <ion-note
                                *ngIf="
                                    accessFormGroup('exerciseData', 'name', i).errors?.required &&
                                    (accessFormGroup('exerciseData', 'name', i).touched ||
                                        accessFormGroup('exerciseData', 'name', i).dirty ||
                                        (isSubmitted$ | async)) &&
                                    !isLoading
                                "
                                slot="error"
                            >
                                {{ 'training.new_training.errors.exercise_name_required' | translate }}
                            </ion-note>
                        </ion-item>
                        <ion-note
                            *ngIf="
                                form.errors?.duplicateExerciseName &&
                                form.errors?.duplicateExerciseName ===
                                    accessFormGroup('exerciseData', 'name', i)?.value &&
                                !isLoading
                            "
                            class="error"
                        >
                            {{ 'training.new_training.errors.exercise_name_duplicate' | translate }}
                        </ion-note>
                    </ion-col>
                    <ion-col size="2">
                        <ion-icon
                            class="delete-exercise-icon"
                            name="trash-bin-outline"
                            color="primary"
                            (click)="deleteExercise(i, accessFormGroup('exerciseData', 'name', i).value)"
                        ></ion-icon>
                    </ion-col>
                </ion-row>
            </ion-grid>
        </ng-container>
        <bl-set
            formControlName="sets"
            [isExerciseFormSubmitted$]="isSubmitted$"
            [isExerciseChanged$]="isExerciseChanged$"
            [exerciseNameControl]="accessFormGroup('exerciseData', 'name', i)"
            [indexExercise]="i"
            [isLoading]="isLoading"
            [editMode]="editMode"
            [editTrainingData]="editTrainingData"
        ></bl-set>
    </ion-card>
</form>
<ng-container *ngIf="currentExercisesState$ | async as currentExercisesState">
    <ion-grid>
        <ion-row>
            <ion-col class="add-exercise-col">
                <ion-button
                    type="button"
                    color="primary"
                    [disabled]="!(isAddingExercisesAllowed$ | async) || (isApiLoading$ | async)"
                    (click)="addExercise(undefined, $event)"
                >
                    {{ 'training.new_training.buttons.add_exercise' | translate }}
                </ion-button>
            </ion-col>
            <ion-col class="ion-text-end log-training-col">
                <ion-button
                    (click)="onSubmit()"
                    [disabled]="!currentExercisesState?.length || (isApiLoading$ | async)"
                >
                {{ 'training.new_training.log_training' | translate }}
                </ion-button>
            </ion-col>
        </ion-row>
        <ion-row>
            <ion-col class="ion-text-center at-least-one-exercise-txt">
                <ion-note
                    *ngIf="
                        form.errors?.emptyTraining &&
                        (isSubmitted$ | async) &&
                        currentExercisesState?.length === 0
                    "
                    class="empty-training-msg"
                >
                    {{ 'training.new_training.errors.at_least_one_exercise' | translate }}
                </ion-note>
            </ion-col>
        </ion-row>
    </ion-grid>
</ng-container>
