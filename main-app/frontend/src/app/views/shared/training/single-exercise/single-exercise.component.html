<form
    *ngFor="let group of form.controls; let i = index"
    class="form"
    [formGroup]="group">
    <ion-card class="wrapper">
        <ng-container formGroupName="exerciseData">
            <ion-grid>
                <ion-row
                    class="ion-text-center exercise-row"
                    [class.exercise-name-required]="accessFormControl('exerciseData', 'name', i).errors?.required &&
                        (accessFormControl('exerciseData', 'name', i).touched ||
                        accessFormControl('exerciseData', 'name', i).dirty ||
                            isSubmitted) &&
                        !isLoading">
                    <ion-col size="10">
                        <ion-item fill="outline">
                            <ion-label position="floating">{{
                                'training.new_training.pick_exercise' | translate
                            }}</ion-label>
                            <ion-select
                                *ngIf="isExercisePicker$ | async"
                                #exercisePicker
                                class="exercise-picker"
                                interface="popover"
                                formControlName="name"
                                (ionChange)="onExerciseNameChange(i, exercisePicker)"
                            >
                                <ion-select-option
                                    *ngFor="
                                        let exercise of exercisesState$ | async | filterAvailableExercises: i
                                    "
                                    [value]="exercise.name"
                                >
                                    {{ exercise.name | translate }}
                                </ion-select-option>
                            </ion-select>
                            <ion-note
                                *ngIf="
                                accessFormControl('exerciseData', 'name', i).errors?.required &&
                                    (accessFormControl('exerciseData', 'name', i).touched ||
                                    accessFormControl('exerciseData', 'name', i).dirty ||
                                        isSubmitted) &&
                                    !isLoading
                                "
                                slot="error"
                            >
                                {{ 'training.new_training.errors.exercise_name_required' | translate }}
                            </ion-note>
                        </ion-item>
                        <ion-note
                            *ngIf="
                                form.errors?.duplicateExerciseName &&
                                form.errors?.duplicateExerciseName ===
                                accessFormControl('exerciseData', 'name', i)?.value &&
                                !isLoading
                            "
                            class="error"
                        >
                            {{ 'training.new_training.errors.exercise_name_duplicate' | translate }}
                        </ion-note>
                    </ion-col>
                    <ion-col size="2">
                        <ion-icon
                            class="delete-exercise-icon"
                            name="trash-outline"
                            color="primary"
                            (click)="deleteExercise(i, accessFormControl('exerciseData', 'name', i).value)"
                        ></ion-icon>
                    </ion-col>
                </ion-row>
            </ion-grid>
        </ng-container>
        <bl-set
            formControlName="sets"
            [editTrainingData]="editTrainingData"
            [indexExercise]="i"
            [changeSetCategoryPayload]="{
                setCategories: accessFormControl('exerciseData', 'setCategories', i).value,
                primarySetCategory: accessFormControl('exerciseData', 'primarySetCategory', i).value
            }"
            [bodyweightControl]="bodyweightControl"
            [exerciseControl]="accessFormControl('exerciseData', 'name', i)"
            [primarySetCategoryControl]="accessFormControl('exerciseData', 'primarySetCategory', i)"
            [isUpdateSetCategoryVisible]="accessFormControl('exerciseData', 'setCategories', i).value.length > 1"
            [isSubmitted]="isSubmitted"
            [editMode]="editMode"
            [isLoading]="isLoading"
        ></bl-set>
    </ion-card>
</form>

<ion-grid>
    <ion-row class="actions">
        <ion-col>
            <ion-button
                class="add-exercise-btn"
                type="button"
                color="primary"
                [disabled]="!(isAddExerciseAllowed$ | async) || isApiLoading"
                (click)="addExercise(undefined, $event)"
            >
                {{ 'training.new_training.buttons.add_exercise' | translate }}
            </ion-button>
        </ion-col>
        <ng-content></ng-content>
    </ion-row>
</ion-grid>
