<mat-spinner
    *ngIf="isLoading"
    class="spinner"
    [diameter]="50"></mat-spinner>
<section
    *ngIf="!isError && !isLoading"
    class="section">
    <form
        *ngIf="form"
        class="main-form"
        autocomplete="off"
        [formGroup]="form"
        (ngSubmit)="onSubmit()">
        <mat-form-field
            appearance="outline"
            class="bodyweight">
            <mat-label class="label">
                {{ 'training.new_training.pick_bodyweight' | translate }}
            </mat-label>
            <input
                #bodyweightRef
                matInput
                type="number"
                formControlName="bodyweight"
                (input)="onBodyweightChange(bodyweightRef.value)">
            <mat-error *ngIf="(bodyweight.touched || bodyweight.dirty) && !bodyweight.valid">
                <mat-error *ngIf="bodyweight.errors?.onlyNumbers">
                    {{ 'training.new_training.errors.only_numbers' | translate }}
                </mat-error>
                <mat-error *ngIf="bodyweight.errors?.min">
                    {{ 'training.new_training.errors.bodyweight_min' | translate }}
                </mat-error>
                <mat-error *ngIf="bodyweight.errors?.max">
                    {{ 'training.new_training.errors.bodyweight_max' | translate }}
                </mat-error>
            </mat-error>
        </mat-form-field>
        <ng-container
            *ngFor="let group of getExercises(); let i = index"
            formArrayName="exercise">
            <ng-container [formGroupName]="i">
                <div
                    class="exercise-wrapper"
                    [class.bodyweight-error]="bodyweight.errors">
                    <mat-form-field
                        appearance="outline"
                        class="exercise-form-field"
                        matTooltipClass="tooltip"
                        matTooltipPosition="above"
                        [matTooltipDisabled]="getDisabledTooltip(i).value"
                        [matTooltip]="getExerciseName(i).value | translate">
                        <mat-label class="label">
                            {{ 'training.new_training.pick_exercise' | translate }}
                        </mat-label>
                        <mat-select
                            #exerciseNameChoice
                            formControlName="name"
                            (selectionChange)="onExerciseNameChange($event, i, exerciseNameChoice)">
                            <mat-optgroup
                                *ngFor="let exercise of exercises$ | newTraining:i:exerciseChanged | async"
                                [label]="exercise.primaryMuscleGroup">
                                <mat-option
                                    class="exercise-option"
                                    [value]="exercise.name">
                                    <img
                                        class="exercise-img"
                                        [src]="exercise.imageUrl">
                                    <p class="exercise-text">{{ exercise.name | translate }}</p>
                                </mat-option>
                            </mat-optgroup>
                        </mat-select>
                        <mat-error
                            *ngIf="getExerciseName(i).errors?.required && isSubmitted">
                            {{ 'training.new_training.errors.exercise_name_required' | translate }}
                        </mat-error>
                    </mat-form-field>
                    <div
                        class="delete-exercise-wrapper"
                        [matTooltip]="'training.new_training.buttons.delete_exercise' | translate"
                        matTooltipPosition="above"
                        matTooltipClass="tooltip">
                        <button
                            type="button"
                            mat-raised-button
                            color="warn"
                            (click)="deleteExercise(i, getExerciseName(i).value)">
                            <mat-icon>delete_forever</mat-icon>
                        </button>
                    </div>
                </div>
                <ng-container
                    formArrayName="sets"
                    *ngFor="let set of getSets(i); let j = index">
                    <ng-container [formGroupName]="j">
                        <div
                            class="sets"
                            [class.sets--after-first]="j > 0">
                            <mat-form-field
                                appearance="outline"
                                class="sets-weight-lifted">
                                <mat-label class="label">
                                    {{ 'training.new_training.weight_lifted' | translate }}
                                </mat-label>
                                <input
                                    matInput
                                    type="text"
                                    formControlName="weightLifted"
                                    (input)="onChangeSets(i,j)">
                                <mat-error
                                    *ngIf="set.get('weightLifted').errors?.required
                                        && getExerciseName(i).value && j === 0">
                                    {{ 'training.new_training.errors.weight_lifted_required' | translate }}
                                </mat-error>
                                <mat-hint
                                    class="sets-weight-lifted--error"
                                    *ngIf="j > 0 && set.errors?.weightLiftedRequired
                                        && !set.get('reps').errors?.pattern">
                                    {{ 'training.new_training.errors.weight_lifted_required' | translate }}
                                </mat-hint>
                                <mat-hint
                                    class="sets-success"
                                    *ngIf="getWeightLifted(i,j).value && getWeightLifted(i,j).valid
                                    && getReps(i,j).value && getReps(i,j).valid && !editMode">
                                    {{ 'training.new_training.set_saved' | translate }}
                                </mat-hint>
                                <mat-error
                                    *ngIf="set.get('weightLifted').errors?.onlyNumbers
                                    && !set.get('weightLifted').errors?.min">
                                    {{ 'training.new_training.errors.only_numbers' | translate }}
                                </mat-error>
                                <mat-error
                                    *ngIf="set.get('weightLifted').errors?.min
                                    && !set.get('weightLifted').errors?.onlyNumbers">
                                    {{ 'training.new_training.errors.weight_lifted_min' | translate }}
                                </mat-error>
                                <mat-error *ngIf="set.get('weightLifted').errors?.max
                                        && !set.get('weightLifted').errors?.onlyNumbers">
                                    {{ 'training.new_training.errors.weight_lifted_max' | translate }}
                                </mat-error>
                            </mat-form-field>
                            <mat-form-field
                                appearance="outline"
                                class="sets-reps">
                                <mat-label class="label">
                                    {{ 'training.new_training.reps_performed' | translate }}
                                </mat-label>
                                <input
                                    matInput
                                    type="text"
                                    formControlName="reps"
                                    (input)="onChangeSets(i,j)">
                                <mat-error
                                    *ngIf="set.get('reps').errors?.required && getExerciseName(i).value && j === 0">
                                    {{ 'training.new_training.errors.reps_required' | translate }}
                                </mat-error>
                                <mat-hint
                                    class="sets-reps--error"
                                    *ngIf="j > 0 && set.errors?.repsRequired
                                        && !set.get('weightLifted').errors?.onlyNumbers
                                        && !set.get('weightLifted').errors?.min">
                                    {{ 'training.new_training.errors.reps_required' | translate }}
                                </mat-hint>
                                <mat-error
                                    *ngIf="set.get('reps').errors?.pattern
                                    && !set.get('weightLifted').errors?.onlyNumbers">
                                    {{ 'training.new_training.errors.only_positive' | translate }}
                                </mat-error>
                                <mat-error
                                    *ngIf="set.get('reps').errors?.min
                                    && !set.get('weightLifted').errors?.onlyNumbers
                                    && !set.get('reps').errors?.pattern">
                                    {{ 'training.new_training.errors.reps_min' | translate }}
                                </mat-error>
                                <mat-error
                                    *ngIf="set.get('reps').errors?.max
                                    && !set.get('weightLifted').errors?.onlyNumbers
                                    && !set.get('reps').errors?.pattern">
                                    {{ 'training.new_training.errors.reps_max' | translate }}
                                </mat-error>
                            </mat-form-field>
                            <div
                                class="delete-set-wrapper"
                                [matTooltip]="adjustDeleteSetTooltip(j) | async"
                                matTooltipPosition="above"
                                [matTooltipClass]="j > 0 ? 'tooltip' : 'tooltip-error'">
                                <button
                                    type="button"
                                    mat-raised-button
                                    color="warn"
                                    class="button-delete-sets"
                                    (click)="deleteSet(i,j)"
                                    [disabled]="j === 0 || isLoading">
                                    <mat-icon class="icon-delete-sets">
                                        delete
                                    </mat-icon>
                                </button>
                            </div>
                        </div>
                    </ng-container>
                </ng-container>
                <div class="add-sets">
                    <button
                        type="button"
                        color="primary"
                        mat-raised-button
                        class="add-sets-button"
                        (click)="addSet(i);"
                        [disabled]="!group.get('name').value || group.errors?.setNotFilled">
                        {{ 'training.new_training.buttons.add_set' | translate }}
                    </button>
                </div>
                <div class="total">
                    <p class="total-text">
                        {{ 'training.new_training.total' | translate }}
                    </p>
                    <mat-form-field
                        appearance="outline"
                        class="total-form-field"
                        [class.at-least-one-set]="group.errors?.atLeastOneSet && isSubmitted">
                        <input
                            matInput
                            type="text"
                            readonly
                            formControlName="total">
                        <mat-hint
                            class="total-form-field--error"
                            *ngIf="group.errors?.atLeastOneSet && isSubmitted">
                            {{ 'training.new_training.errors.at_least_one_set' | translate }}
                        </mat-hint>
                    </mat-form-field>
                </div>
            </ng-container>
        </ng-container>
        <div class="add-exercise">
            <div
                *ngIf="(isAddingExercisesAllowed$ | async) as isAddingExercisesAllowed"
                [matTooltip]="(adjustAddExerciseTooltip(isAddingExercisesAllowed[0].length, isAddingExercisesAllowed[1].length)) | async"
                [matTooltipClass]="'tooltip-error'">
                <button
                    mat-raised-button
                    type="button"
                    color="accent"
                    class="add-exercise-button"
                    (click)="addExercise(false, $event)"
                    [disabled]="(isAddingExercisesAllowed[0].length >= isAddingExercisesAllowed[1].length)
                        || (!getExerciseName(getExercises().length - 1)?.value) && getExercises().length > 0
                        || this.getExercises()[this.getExercises().length - 1]?.errors?.atLeastOneSet">
                    {{ 'training.new_training.buttons.add_exercise' | translate }}
                </button>
            </div>
            <button
                class="finish-training"
                type="submit"
                mat-raised-button
                color="primary"
                [matTooltip]="'training.new_training.finish_training' | translate"
                matTooltipPosition="above"
                matTooltipClass="tooltip">
                <mat-icon class="finish-training-icon">done</mat-icon>
            </button>
        </div>
    </form>
</section>

<ng-container *ngIf="isError && !isLoading">
    <div class="error-wrapper">
        <img
            class="error-image"
            src="../../../../assets/svgs/error1.svg">
        <h3 class="error-title">
            {{ 'training.new_training.errors.new_training_error_title' | translate }}
        </h3>
        <span
            *ngIf="editMode"
            class="error-description">
            {{ 'training.new_training.errors.new_training_error_description' | translate }}
        </span>
        <span
            *ngIf="!editMode"
            class="error-description">
            {{ 'training.new_training.errors.new_training_error_load' | translate }}
        </span>
        <button
            mat-raised-button
            color="primary"
            type="button"
            (click)="tryAgain()">
            {{ 'common.try_again' | translate }}
        </button>
    </div>
</ng-container>
