<form
    [formGroup]="$any(form)"
    (ngSubmit)="onSubmit()">
    <ng-container
        *ngFor="let group of getExercises(); let i = index">
        <ng-container [formGroupName]="i">
            <div class="exercise-wrapper">
                <mat-form-field
                    appearance="outline"
                    class="exercise-form-field"
                    matTooltipClass="tooltip"
                    matTooltipPosition="above"
                    [matTooltipDisabled]="accessFormField('disabledTooltip', i).value"
                    [matTooltip]="accessFormField('name', i).value | translate">
                    <mat-label class="label">
                        {{ 'training.new_training.pick_exercise' | translate }}
                    </mat-label>
                    <mat-select
                        disableRipple
                        #exerciseNameChoice
                        formControlName="name"
                        [errorStateMatcher]="form.errors?.duplicateExerciseName === accessFormField('name', i).value ? singleExerciseErrorHelper : null"
                        (selectionChange)="onExerciseNameChange($event, i, exerciseNameChoice)">
                        <mat-optgroup
                            *ngFor="let exercise of exercises$ | newTraining:i:exerciseChanged | async"
                            [label]="exercise.primaryMuscleGroup">
                            <mat-option
                                class="exercise-option"
                                [value]="exercise.name">
                                <img
                                    class="exercise-img"
                                    [src]="exercise.imageUrl">
                                <p class="exercise-text">
                                    {{ exercise.name | translate }}
                                </p>
                            </mat-option>
                        </mat-optgroup>
                    </mat-select>
                    <mat-error
                        *ngIf="accessFormField('name', i).errors?.required"
                        class="error">
                        {{ 'training.new_training.errors.exercise_name_required' | translate }}
                    </mat-error>
                    <mat-error
                        *ngIf="form.errors?.duplicateExerciseName && form.errors?.duplicateExerciseName === accessFormField('name', i).value"
                        class="error">
                        {{ 'training.new_training.errors.exercise_name_duplicate' | translate }}
                    </mat-error>
                </mat-form-field>
                <div
                    class="delete-exercise-wrapper"
                    matTooltipPosition="above"
                    matTooltipClass="tooltip"
                    [matTooltip]="'training.new_training.buttons.delete_exercise' | translate">
                    <button
                        mat-raised-button
                        type="button"
                        color="warn"
                        (click)="deleteExercise(i, accessFormField('name', i).value)">
                        <mat-icon>delete_forever</mat-icon>
                    </button>
                </div>
            </div>
            <bl-sets
                formControlName="sets"
                [isExerciseFormSubmitted$]="isSubmitted$$.asObservable()"
                [exerciseStateChanged$]="exerciseStateChanged$$.asObservable()"
                [exerciseNameControl]="accessFormField('name', i)"
                [indexExercise]="i"
                [isLoading]="isLoading"
                [editMode]="editMode"
                (setAdded)="onChangeSets($event)"
                (setDeleted)="deleteSet($event)"
                (formStateChanged)="onSetFormChange($event)"></bl-sets>
            <bl-total-weight formControlName="total"></bl-total-weight>
        </ng-container>
    </ng-container>
    <div
        *ngIf="(currentExerciseState$ | async) as currentExerciseState"
        class="add-exercise">
        <div
            matTooltipClass="tooltip-error"
            [matTooltip]="showAddExerciseTooltip(
                currentExerciseState[0].length,
                currentExerciseState[1].length) | async">
            <button
                mat-raised-button
                type="button"
                color="primary"
                class="add-exercise-button"
                [disabled]="isAddingExercisesDisabled(
                    currentExerciseState[0].length,
                    currentExerciseState[1].length)"
                (click)="addExercise($event)">
                {{ 'training.new_training.buttons.add_exercise' | translate }}
            </button>
        </div>
        <div
            matTooltipClass="tooltip-error"
            matTooltipPosition="below"
            [matTooltip]="currentExerciseState[0]?.length === 0 ? ('training.new_training.errors.at_least_one_exercise' | translate) : ''">
            <button
                mat-raised-button
                class="finish-training"
                type="submit"
                color="primary"
                matTooltipClass="tooltip"
                matTooltipPosition="above"
                [matTooltip]="currentExerciseState[0]?.length > 0 ? ('training.new_training.finish_training' | translate) : ''"
                [disabled]="currentExerciseState[0]?.length === 0">
                <mat-icon class="finish-training-icon">done</mat-icon>
            </button>
        </div>
        <span
            *ngIf="form?.errors?.emptyTraining && (isSubmitted$$ | async) && currentExerciseState[0]?.length === 0"
            class="empty-training-msg">
            {{ 'training.new_training.errors.at_least_one_exercise' | translate }}
        </span>
    </div>
</form>
